<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LevelUpCrew — Quests</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    :root{--bg:#f6f7fb;--surface:#fff;--stroke:#e6e8ef;--text:#0f172a;--muted:#64748b;--primary:#3b82f6;--shadow:0 10px 24px rgba(15,23,42,.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--stroke);box-shadow:var(--shadow);padding:14px 20px;display:flex;gap:16px}
    a{color:#111;text-decoration:none}
    nav a{padding:8px 12px;border-radius:10px}
    nav a.active{background:#eef2ff;color:#1e293b}
    .wrap{max-width:980px;margin:18px auto;padding:0 12px}
    .card{background:var(--surface);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
    .muted{color:var(--muted)}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    input[type=file]{display:block;margin:8px 0}
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="quests.html" class="active">Quests</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="profile.html">Profile</a>
    </nav>
  </header>

  <div class="wrap">
    <h2>Available Quests</h2>
    <div id="questList"></div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc,
    query, orderBy, where, addDoc
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

  // IMPORTANT: correct storage bucket
  const cfg = {
    apiKey:"AIzaSyDC_P0f0PX7USficIiac3QLM8ARaVJu3Ic",
    authDomain:"levelupcrew-ec008.firebaseapp.com",
    projectId:"levelupcrew-ec008",
    storageBucket:"levelupcrew-ec008.appspot.com",   // <-- FIXED
    messagingSenderId:"112573541497",
    appId:"1:112573541497:web:9395e25f7eb141405838a8"
  };
  const app = initializeApp(cfg);
  const db  = getFirestore(app);
  const st  = getStorage(app);

  // session guard
  const email=(localStorage.getItem('current_user')||'').toLowerCase();
  if(!email || email==='adminaccess1111'){ location.href='login.html'; }

  // supports either #list or #questList
  const mount = document.getElementById('list') || document.getElementById('questList');

  // helpers
  async function ensureUser(){
    const ref=doc(db,'users',email);
    const snap=await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{email,level:1,points:0,createdAt:Date.now(),password:'',completedQuests:[]},{merge:true});
      return {email,level:1,points:0,completedQuests:[]};
    }
    return snap.data();
  }
  async function doneSet(){
    const qs = await getDocs(query(collection(db,'completions'), where('user','==',email)));
    const set = new Set();
    qs.forEach(d => { const c=d.data(); if(c.questId) set.add(c.questId); });
    return set;
  }

  function wireFinishForCard(card, quest){
    // Works with your earlier DOM:
    // - "Start" button: [data-id]
    // - Finish area button: [data-finishbtn="<questId>"]
    // - File input: #file-<questId> OR any input[type=file] inside this card
    const qid = quest.id;
    const startBtn = card.querySelector(`button[data-id="${qid}"]`);
    const finishBtn = card.querySelector(`button[data-finishbtn="${qid}"]`) || card.querySelector('.finish');
    const fileInput = card.querySelector(`#file-${qid}`) || card.querySelector('input[type="file"]');

    // Enable finish once file chosen (robust for phones)
    if(fileInput && finishBtn){
      const updateEnable = () => { finishBtn.disabled = !(fileInput.files && fileInput.files[0]); };
      fileInput.addEventListener('change', updateEnable);
      fileInput.addEventListener('input', updateEnable);
      updateEnable();
    }

    // If you still use "Start" to mark current quest, keep it working:
    if(startBtn){
      startBtn.addEventListener('click', async ()=>{
        await updateDoc(doc(db,'users',email), { weeklyQuest:{ id: qid, title: quest.title, points: quest.points } });
        // show the finish area if your HTML hides it until started
        const fin = card.querySelector(`[data-finish="${qid}"]`);
        if(fin) fin.style.display='block';
      });
    }

    // Finish handler (upload → completion → points/level → remove card)
    if(finishBtn){
      finishBtn.addEventListener('click', async ()=>{
        const file = fileInput?.files?.[0];
        if(!file){ alert('Please upload a photo or video proof.'); return; }

        try{
          // re-read quest doc for authoritative points/title
          const qSnap = await getDoc(doc(db,'quests', qid));
          if(!qSnap.exists()){ alert('Quest not found'); return; }
          const qd = qSnap.data();

          // upload to Storage
          const path = `proofs/${encodeURIComponent(email)}/${qid}-${Date.now()}-${file.name}`;
          const r = sRef(st, path);
          await uploadBytes(r, file);
          const url = await getDownloadURL(r);

          // write completion
          await addDoc(collection(db,'completions'),{
            user: email,
            questId: qid,
            questTitle: qd.title || '',
            points: Number(qd.points||0),
            mediaType: file.type.startsWith('video/') ? 'video' : 'image',
            mediaUrl: url,
            storagePath: path,
            createdAt: Date.now()
          });

          // update user points/level
          const uref = doc(db,'users',email);
          const us = await getDoc(uref);
          let points = Number(us.data()?.points||0) + Number(qd.points||0);
          let level  = Number(us.data()?.level ||1);
          while(points>=100){ points-=100; level++; }
          await updateDoc(uref,{ points, level });

          // remove card from UI (disappear)
          card.remove();
        }catch(err){
          console.error(err);
          alert('Upload or save failed. Check Firebase Storage rules and try again.');
        }
      });
    }
  }

  async function render(){
    mount.innerHTML = 'Loading quests…';
    await ensureUser();
    const completed = await doneSet();

    const snap = await getDocs(query(collection(db,'quests'), orderBy('createdAt','desc')));
    const quests = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(q=> !completed.has(q.id) );

    if(!quests.length){ mount.innerHTML = '<div class="muted">No available quests.</div>'; return; }

    // *** KEEP YOUR EXISTING HTML ***
    // We do NOT re-render your cards. We just wire up existing DOM.
    // So here, we look for card elements that contain a data-id or data-finishbtn for each quest.
    // If your HTML already rendered cards, do wiring only:
    const cards = Array.from(mount.querySelectorAll('[data-finish], .card, [data-id]'));
    if(cards.length){
      // cards are already in DOM — wire matching ones
      quests.forEach(q=>{
        // find the card that references this quest id (by data-finish or data-id)
        const card = cards.find(el =>
          el.matches(`[data-finish="${q.id}"]`) ||
          el.querySelector?.(`button[data-id="${q.id}"]`) ||
          el.dataset?.qid === q.id
        ) || null;
        if(card) wireFinishForCard(card, q);
      });
      mount.querySelectorAll('button.finish').forEach(btn=>{
        if(!btn.hasAttribute('data-finishbtn')) btn.disabled = false;
      });
      return;
    }

    // If your page didn't pre-render cards, fall back to a minimal renderer (no styling changes)
    mount.innerHTML = quests.map(q=>`
      <div class="card" data-qid="${q.id}">
        <div style="font-weight:700">${q.title}</div>
        <div class="muted">+${q.points} points</div>
        <input type="file" accept="image/*,video/*">
        <button class="finish">Finish</button>
      </div>
    `).join('');
    mount.querySelectorAll('.card').forEach(card=>{
      const q = quests.find(x=>x.id===card.dataset.qid);
      wireFinishForCard(card, q);
    });
  }

  render().catch(e=>{ console.error(e); mount.innerHTML='Failed to load quests.'; });
</script>
