<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LevelUpCrew — Quests</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    :root{--bg:#f6f7fb;--surface:#fff;--stroke:#e6e8ef;--text:#0f172a;--muted:#64748b;--primary:#3b82f6;--shadow:0 10px 24px rgba(15,23,42,.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--surface);border-bottom:1px solid var(--stroke);box-shadow:var(--shadow);padding:14px 20px}
    nav{display:flex;gap:10px;flex-wrap:wrap}
    nav a{color:#111;text-decoration:none;padding:8px 12px;border-radius:10px}
    nav a.active{background:#eef2ff;color:#1e293b}
    .wrap{max-width:980px;margin:18px auto;padding:0 12px}
    h2{margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    .card{background:var(--surface);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .title{font-weight:800}
    .muted{color:var(--muted);font-size:.95rem}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    input[type=file]{display:block}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .note{border:1px solid #dbeafe;background:#eff6ff;color:#1e3a8a;border-radius:12px;padding:10px;margin-top:10px;display:none}
    .empty{color:var(--muted);padding:20px;border:1px dashed var(--stroke);border-radius:16px;background:#fff}
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="quests.html" class="active">Quests</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="profile.html">Profile</a>
    </nav>
  </header>

  <div class="wrap">
    <h2>Available Quests</h2>
    <div id="questList" class="grid">
      <!-- cards render here -->
    </div>
    <div id="empty" class="empty" style="display:none">No available quests.</div>
  </div>

  <script type="module">
    // ===== Firebase (correct bucket) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc,
      query, orderBy, where, addDoc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

    const cfg = {
      apiKey:"AIzaSyDC_P0f0PX7USficIiac3QLM8ARaVJu3Ic",
      authDomain:"levelupcrew-ec008.firebaseapp.com",
      projectId:"levelupcrew-ec008",
      storageBucket:"levelupcrew-ec008.appspot.com",   // <-- IMPORTANT
      messagingSenderId:"112573541497",
      appId:"1:112573541497:web:9395e25f7eb141405838a8"
    };
    const app = initializeApp(cfg);
    const db  = getFirestore(app);
    const st  = getStorage(app);

    // ===== Session guard =====
    const who = (localStorage.getItem('current_user')||'').toLowerCase();
    if(!who || who==='adminaccess1111'){ location.href='login.html'; }

    const listEl  = document.getElementById('questList');
    const emptyEl = document.getElementById('empty');

    // ===== Helpers =====
    async function ensureUser() {
      const ref = doc(db,'users',who);
      const s = await getDoc(ref);
      if(!s.exists()){
        await setDoc(ref,{
          email: who, displayName:'', level:1, points:0,
          password:'', createdAt: Date.now(), completedQuests:[]
        }, { merge:true });
        return { email:who, level:1, points:0 };
      }
      return s.data();
    }

    async function getCompletedSet() {
      const s = await getDocs(query(collection(db,'completions'), where('user','==', who)));
      const done = new Set();
      s.forEach(d=>{ const c=d.data(); if(c.questId) done.add(c.questId); });
      return done;
    }

    function cardTemplate(q){
      // simple consistent layout: title, points, file, Finish, status
      return `
        <div class="card" data-qid="${q.id}">
          <div class="title">${q.title || '(no title)'}</div>
          <div class="muted">+ ${q.points ?? 0} points</div>
          <div class="row">
            <input type="file" accept="image/*,video/*" class="proof">
            <button class="btn finish" disabled>Finish</button>
          </div>
          <div class="note status"></div>
        </div>
      `;
    }

    function setStatus(card, msg, good=false){
      const box = card.querySelector('.status');
      box.style.display='block';
      box.style.borderColor = good ? '#bbf7d0' : '#dbeafe';
      box.style.background  = good ? '#ecfdf5' : '#eff6ff';
      box.style.color       = good ? '#065f46' : '#1e3a8a';
      box.innerHTML = msg;
    }

    // ===== Main render =====
    async function loadQuests(){
      listEl.innerHTML = '';
      emptyEl.style.display = 'none';

      await ensureUser();
      const done = await getCompletedSet();

      const snap = await getDocs(query(collection(db,'quests'), orderBy('createdAt','desc')));
      const quests = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(q=> !done.has(q.id) );

      if(!quests.length){
        emptyEl.style.display = 'block';
        return;
      }

      listEl.innerHTML = quests.map(cardTemplate).join('');

      // Wire each card
      listEl.querySelectorAll('.card').forEach(card=>{
        const qid = card.getAttribute('data-qid');
        const proof = card.querySelector('.proof');
        const btn = card.querySelector('.finish');

        // Enable Finish after file chosen (robust on mobile)
        const enable = () => { btn.disabled = !(proof.files && proof.files[0]); };
        proof.addEventListener('change', enable);
        proof.addEventListener('input', enable);
        enable();

        btn.addEventListener('click', async ()=>{
          const file = proof.files && proof.files[0];
          if(!file){ alert('Please upload a photo or video proof.'); return; }

          btn.disabled = true;
          setStatus(card,'Uploading proof…');

          try{
            // read quest doc for authoritative values
            const qSnap = await getDoc(doc(db,'quests', qid));
            if(!qSnap.exists()){ setStatus(card,'Quest not found.'); btn.disabled=false; return; }
            const q = qSnap.data();
            const qPoints = Number(q.points || 0);

            // upload to Firebase Storage
            const path = `proofs/${encodeURIComponent(who)}/${qid}-${Date.now()}-${file.name}`;
            const rf = sRef(st, path);
            await uploadBytes(rf, file);
            const url = await getDownloadURL(rf);

            // write a completion document
            await addDoc(collection(db,'completions'), {
              user: who,
              questId: qid,
              questTitle: q.title || '',
              points: qPoints,
              mediaType: file.type.startsWith('video/') ? 'video' : 'image',
              mediaUrl: url,
              storagePath: path,
              createdAt: Date.now()
            });

            // update user points/level (100 pts per level, rollover)
            const uref = doc(db,'users', who);
            const us = await getDoc(uref);
            let points = Number(us.data()?.points || 0) + qPoints;
            let level  = Number(us.data()?.level  || 1);
            while(points >= 100){ points -= 100; level++; }
            await updateDoc(uref, { points, level });

            // remove card and show success
            setStatus(card, 'Completed! This quest will now disappear from your list.', true);
            setTimeout(()=> card.remove(), 400);
            // If list becomes empty, show empty message
            setTimeout(()=> {
              if(!listEl.querySelector('.card')) emptyEl.style.display = 'block';
            }, 450);
          }catch(err){
            console.error(err);
            setStatus(card, 'Failed to upload or save. Check your connection and try again.');
            btn.disabled = false;
          }
        });
      });
    }

    // ===== Kick off =====
    loadQuests().catch(e=>{
      console.error(e);
      listEl.innerHTML = '';
      emptyEl.style.display='block';
      emptyEl.textContent = 'Failed to load quests. Please refresh.';
    });
  </script>
</body>
</html>
