<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LevelUpCrew — Quests</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <style>
    :root { --bg:#f6f7fb; --surface:#fff; --stroke:#e6e8ef; --text:#0f172a; --primary:#3b82f6; --shadow:0 10px 24px rgba(15,23,42,.06) }
    * { box-sizing:border-box; }
    body { margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; min-height:100vh }

    /* NAV */
    nav { width:100%; background:var(--surface); border-bottom:1px solid var(--stroke); box-shadow:var(--shadow); padding:14px 20px; display:flex; justify-content:center; gap:25px; position:sticky; top:0; z-index:10 }
    nav a { color:var(--text); text-decoration:none; font-weight:600; font-size:1rem; transition:color .2s }
    nav a:hover, nav a.active { color:var(--primary) }

    header { width:100%; max-width:720px; display:flex; justify-content:space-between; align-items:center; background:var(--surface); border:1px solid var(--stroke); border-radius:16px; padding:18px 24px; box-shadow:var(--shadow); margin:25px 0 }
    .brand { font-weight:700; font-size:1.3rem; color:var(--primary) }

    .card { background:var(--surface); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); padding:20px; width:100%; max-width:720px; margin-bottom:20px }
    .quest { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--stroke) }
    .quest:last-child { border-bottom:none }
    .q-title { font-weight:700 }
    .q-points { color:#64748b; font-size:.92rem; margin-top:2px }
    .btn { background:var(--primary); color:#fff; border:none; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer }
    .btn:hover { background:#2563eb }
    .btn.disabled { opacity:.6; cursor:not-allowed }

    .finish { margin-top:16px; border:1px dashed var(--primary); background:#f8fbff; border-radius:14px; padding:14px }
    .proof { display:flex; gap:12px; align-items:center }
    .preview { width:72px; height:72px; border:1px solid var(--stroke); border-radius:10px; object-fit:cover; display:none }
    .hint { color:#64748b; font-size:.9rem; margin-top:6px }
    .empty { color:#6b7280; text-align:center; padding:12px 0 0 }
  </style>
</head>
<body>
  <!-- NAV -->
<nav>
  <a href="dashboard.html">Dashboard</a>
  <a href="quests.html" class="active">Quests</a>
  <a href="leaderboard.html">Leaderboard</a>
  <a href="profile.html">Profile</a>
</nav>


  <header>
    <div class="brand">LevelUpCrew</div>
    <div id="who" class="hint"></div>
  </header>

  <div class="card">
    <h2 style="margin:0 0 8px 0;">Available Quests</h2>
    <div id="questList"></div>
    <div id="noneMsg" class="empty" style="display:none;">No quests available — check back later.</div>

    <!-- Finish area (appears when a quest is selected) -->
    <div id="finishWrap" class="finish" style="display:none;">
      <strong id="finishTitle">Finish Selected Quest</strong>
      <div class="proof" style="margin-top:10px;">
        <img id="preview" class="preview" alt="proof preview">
        <input type="file" id="proofInput" accept="image/*">
      </div>
      <div class="hint">Upload one event photo as proof, then click Finish.</div>
      <button class="btn" id="finishBtn" style="margin-top:10px;">Finish</button>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, addDoc
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

  // ---- session guard ----
  const email = (localStorage.getItem('current_user')||'').toLowerCase();
  if (!email) location.href = 'login.html';
  if (email === 'adminaccess1111') location.href = 'admin.html';

  // ---- firebase (bucket fixed) ----
  const cfg = {
    apiKey: "AIzaSyDC_P0f0PX7USficIiac3QLM8ARaVJu3Ic",
    authDomain: "levelupcrew-ec008.firebaseapp.com",
    projectId: "levelupcrew-ec008",
    storageBucket: "levelupcrew-ec008.appspot.com",
    messagingSenderId: "112573541497",
    appId: "1:112573541497:web:9395e25f7eb141405838a8"
  };
  const app = initializeApp(cfg);
  const db  = getFirestore(app);
  const st  = getStorage(app);

  // ---- ensure containers exist (keeps your layout) ----
  let listEl  = document.getElementById('questList');
  let noneMsg = document.getElementById('noneMsg');
  if (!listEl) {
    listEl = document.createElement('div');
    listEl.id = 'questList';
    listEl.className = 'grid';
    // append under the "Available Quests" card if present, else at end of page
    const cards = [...document.querySelectorAll('.card, .wrap, main, body')];
    (cards[0] || document.body).appendChild(listEl);
  }
  if (!noneMsg) {
    noneMsg = document.createElement('div');
    noneMsg.id = 'noneMsg';
    noneMsg.className = 'empty';
    noneMsg.style.display = 'none';
    noneMsg.textContent = 'No available quests.';
    listEl.after(noneMsg);
  }
  // small inline debug (hidden unless problem)
  const dbg = document.createElement('div');
  dbg.id = 'debug';
  dbg.style.cssText = 'margin-top:8px;color:#64748b;font-size:.9rem;display:none';
  noneMsg.after(dbg);
  const debug = m => { dbg.style.display='block'; dbg.textContent = m; console.log('[quests]', m); };

  async function ensureUser(){
    const uref = doc(db,'users',email);
    const s = await getDoc(uref);
    if (!s.exists()) {
      await setDoc(uref, { email, level:1, points:0, badge:'Beginner', completedQuests:[], createdAt: Date.now() }, { merge:true });
      return { level:1, points:0, completedQuests:[] };
    }
    return s.data();
  }

  const tpl = (q, selectedId, done) => `
    <div class="card ${selectedId===q.id?'current':''}">
      <div class="quest">
        <div>
          <div class="q-title">${q.title || '(no title)'}</div>
          <div class="q-points">+${q.points ?? 0} points</div>
        </div>
        <button class="btn ${done.includes(q.id)?'disabled':''}" data-id="${q.id}" data-title="${q.title||''}" data-p="${q.points||0}" ${done.includes(q.id)?'disabled':''}>
          ${done.includes(q.id)?'Completed':'Start'}
        </button>
      </div>
      <div class="finish" data-finish="${q.id}" style="display:${selectedId===q.id?'block':'none'}">
        <div class="muted" style="margin-bottom:8px">Upload proof (photo or video). One file is enough.</div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <img  class="preview" id="img-${q.id}" style="display:none" alt="">
          <video class="preview" id="vid-${q.id}" style="display:none" controls></video>
          <input type="file" accept="image/*,video/*" id="file-${q.id}">
          <button class="btn" data-finishbtn="${q.id}">Finish</button>
        </div>
      </div>
    </div>
  `;

  async function render(){
    try{
      const user = await ensureUser();
      const done = user.completedQuests || [];
      const selectedId = (user.weeklyQuest || {}).id || null;

      // 🔁 no orderBy (some docs may miss createdAt)
      const snap = await getDocs(collection(db,'quests'));

      const quests = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      if (snap.empty) { noneMsg.style.display='block'; listEl.innerHTML=''; debug('Fetched 0 quests (empty snapshot).'); return; }

      // hide quests already completed
      const available = quests.filter(q => !done.includes(q.id));
      if (!available.length) { noneMsg.style.display='block'; listEl.innerHTML=''; debug(`Fetched ${quests.length} quests, but all are completed.`); return; }

      noneMsg.style.display='none';
      listEl.innerHTML = available.map(q => tpl(q, selectedId, done)).join('');

      // Start
      listEl.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if (btn.classList.contains('disabled')) return;
          const id=btn.dataset.id, title=btn.dataset.title, points=Number(btn.dataset.p||0);
          await updateDoc(doc(db,'users',email), { weeklyQuest:{ id, title, points } });
          render();
        });
      });

      // Preview
      listEl.querySelectorAll('input[type=file]').forEach(inp=>{
        inp.addEventListener('change', e=>{
          const f=e.target.files[0]; if(!f) return;
          const id=e.target.id.replace('file-','');
          const isVid=f.type.startsWith('video/');
          const img=document.getElementById('img-'+id), vid=document.getElementById('vid-'+id);
          if(isVid){ img.style.display='none'; vid.style.display='block'; vid.src=URL.createObjectURL(f); }
          else     { vid.style.display='none'; img.style.display='block'; img.src=URL.createObjectURL(f); }
        });
      });

      // Finish
      listEl.querySelectorAll('button[data-finishbtn]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.dataset.finishbtn;
          const file = document.getElementById('file-'+id).files[0];
          if(!file){ alert('Please upload a photo or video.'); return; }

          try{
            // upload
            const ts = Date.now();
            const ref = sRef(st, `proofs/${encodeURIComponent(email)}/${id}/${ts}-${file.name}`);
            await uploadBytes(ref, file);
            const url = await getDownloadURL(ref);

            const usRef = doc(db,'users',email);
            const us = (await getDoc(usRef)).data();
            const w = us.weeklyQuest;
            if(!w || w.id!==id){ alert('Please press Start on this quest first.'); return; }

            await addDoc(collection(db,'completions'), {
              user: email, questId: id, questTitle: w.title, points: Number(w.points||0),
              mediaType: file.type.startsWith('video/')?'video':'image',
              mediaUrl: url, createdAt: ts
            });

            // level math
            let pts = Number(us.points||0) + Number(w.points||0);
            let lvl = Number(us.level||1);
            while(pts>=100){ pts-=100; lvl++; }
            const badge = lvl>=50?'Diamond':lvl>=40?'Platinum':lvl>=30?'Gold':lvl>=20?'Silver':lvl>=10?'Bronze':'Beginner';

            await updateDoc(usRef, {
              points:pts, level:lvl, badge,
              completedQuests:[...(us.completedQuests||[]), id],
              weeklyQuest: null
            });

            // remove from UI
            btn.closest('.card').remove();
            if(!listEl.querySelector('.card')) noneMsg.style.display='block';
            alert('Submitted! Admin can review your proof.');
          }catch(e){
            console.error(e);
            alert('Upload or save failed. Check Storage Rules and bucket.');
          }
        });
      });

      debug(`Fetched ${quests.length} quests, showing ${available.length}.`);
    }catch(err){
      console.error(err);
      listEl.innerHTML=''; noneMsg.style.display='block';
      const msg = (err?.code==='permission-denied')
        ? 'Permission denied. Set Firestore Rules to allow reads while testing.'
        : 'Could not load quests. See console.';
      debug(msg);
    }
  }

  render();
</script>

</body>
</html>





