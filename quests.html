<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LevelUpCrew — Quests</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
  <style>
    :root{--bg:#f6f7fb;--surface:#fff;--stroke:#e6e8ef;--text:#0f172a;--muted:#64748b;--primary:#3b82f6;--shadow:0 10px 24px rgba(15,23,42,.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:var(--surface);border-bottom:1px solid var(--stroke);box-shadow:var(--shadow);padding:14px 20px;display:flex;gap:16px}
    a{color:#111;text-decoration:none}
    nav a{padding:8px 12px;border-radius:10px}
    nav a.active{background:#eef2ff;color:#1e293b}
    .wrap{max-width:980px;margin:18px auto;padding:0 12px}
    .card{background:var(--surface);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:14px}
    .muted{color:var(--muted)}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    input[type=file]{display:block;margin:8px 0}
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="quests.html" class="active">Quests</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="profile.html">Profile</a>
    </nav>
  </header>

  <div class="wrap">
    <h2>Available Quests</h2>
    <div id="questList"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc,
      query, orderBy, where, addDoc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

    const cfg = {
      apiKey:"AIzaSyDC_P0f0PX7USficIiac3QLM8ARaVJu3Ic",
      authDomain:"levelupcrew-ec008.firebaseapp.com",
      projectId:"levelupcrew-ec008",
      storageBucket:"levelupcrew-ec008.firebasestorage.app",
      messagingSenderId:"112573541497",
      appId:"1:112573541497:web:9395e25f7eb141405838a8"
    };
    const app = initializeApp(cfg);
    const db  = getFirestore(app);
    const st  = getStorage(app);

    const who = localStorage.getItem('current_user') || '';
    if (!who || who === 'adminaccess1111') location.href = 'login.html';

    const listEl = document.getElementById('questList');

    async function getUser() {
      const r = doc(db,'users', who);
      const s = await getDoc(r);
      if (!s.exists()) {
        await setDoc(r, { email: who, level: 1, points: 0, createdAt: Date.now(), password: '' }, { merge:true });
        return { email: who, level: 1, points: 0 };
      }
      return s.data();
    }
    async function getCompletedIds() {
      const q = query(collection(db,'completions'), where('user','==', who));
      const s = await getDocs(q);
      const set = new Set();
      s.forEach(d=>{ const c=d.data(); if(c.questId) set.add(c.questId); });
      return set;
    }

    function questCard(q) {
      return `
        <div class="card" data-qid="${q.id}">
          <div style="font-weight:800">${q.title}</div>
          <div class="muted">+ ${q.points} points</div>
          <input type="file" accept="image/*,video/*" class="proof">
          <button class="btn finish" disabled>Finish</button>
          <div class="muted status" style="margin-top:8px;display:none"></div>
        </div>
      `;
    }
    function setStatus(card, html){ const el = card.querySelector('.status'); el.innerHTML = html; el.style.display='block'; }

    async function loadQuests(){
      listEl.innerHTML = 'Loading quests…';
      await getUser();
      const done = await getCompletedIds();

      const snap = await getDocs(query(collection(db,'quests'), orderBy('createdAt','desc')));
      const quests = snap.docs.map(d=>({ id:d.id, ...d.data() })).filter(q=>!done.has(q.id));

      if(!quests.length){ listEl.innerHTML = `<div class="muted">No available quests.</div>`; return; }
      listEl.innerHTML = quests.map(questCard).join('');

      listEl.querySelectorAll('.card').forEach(card=>{
        const qid = card.dataset.qid;
        const proof = card.querySelector('.proof');
        const btn = card.querySelector('.finish');

        proof.addEventListener('change', ()=> btn.disabled = !(proof.files && proof.files[0]) );

        btn.addEventListener('click', async ()=>{
          const file = proof.files && proof.files[0];
          if(!file){ alert('Attach proof (photo/video)'); return; }
          btn.disabled = true; setStatus(card,'Uploading proof…');

          try{
            const qsnap = await getDoc(doc(db,'quests', qid));
            if(!qsnap.exists()){ setStatus(card,'Quest not found.'); return; }
            const qData = qsnap.data();

            const path = `proofs/${who}/${qid}-${Date.now()}-${file.name}`;
            const r = sRef(st, path);
            await uploadBytes(r, file);
            const url = await getDownloadURL(r);

            await addDoc(collection(db,'completions'), {
              user: who,
              questId: qid,
              questTitle: qData.title || '',
              points: qData.points || 0,
              proofURL: url,
              storagePath: path,
              createdAt: Date.now()
            });

            // points/level update
            const uref = doc(db,'users', who);
            const us = await getDoc(uref);
            let points = 0, level = 1;
            if(us.exists()){ points = Number(us.data().points||0); level = Number(us.data().level||1); }
            points += Number(qData.points||0);
            const inc = Math.floor(points/100);
            if(inc>0){ level += inc; points = points%100; }
            await updateDoc(uref, { points, level });

            setStatus(card,'Completed! This quest will disappear.');
            setTimeout(()=> card.remove(), 600);
          }catch(err){
            console.error(err);
            setStatus(card,'<span style="color:#b91c1c">Failed. Try again.</span>');
            btn.disabled = false;
          }
        });
      });
    }

    loadQuests().catch(e=>{
      console.error(e); listEl.innerHTML = 'Failed to load quests.';
    });
  </script>
</body>
</html>



